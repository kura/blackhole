<!DOCTYPE html><html> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0"><link rel=stylesheet type=text/css href=../../_static/fonts/open-sans/stylesheet.css><link rel=stylesheet type=text/css href=../../_static/fonts/source-serif-pro/source-serif-pro.css><link rel=stylesheet type=text/css href=../../_static/css/bootstrap.min.css><link rel=stylesheet type=text/css href=../../_static/css/bootstrap-theme.min.css><meta name=viewport content="width=device-width, initial-scale=1.0"><title>blackhole.config &#8212; Blackhole 2.1.19 documentation</title><link rel=stylesheet type=text/css href=../../_static/pygments.css><link rel=stylesheet type=text/css href=../../_static/blackhole.css><script data-url_root=../../ id=documentation_options src=../../_static/documentation_options.js></script><script src=../../_static/jquery.js></script><script src=../../_static/underscore.js></script><script src=../../_static/doctools.js></script><link rel=search type=application/opensearchdescription+xml title="Search within Blackhole 2.1.19 documentation" href=../../_static/opensearch.xml><link rel=index title=Index href=../../genindex.html><link rel=search title=Search href=../../search.html></head><body> <div class=related role=navigation aria-label="related navigation"> <h3>Navigation</h3> <ul> <li class=right style="margin-right: 10px"> <a href=../../genindex.html title="General Index" accesskey=I>index</a></li> <li class=right> <a href=../../py-modindex.html title="Python Module Index">modules</a> |</li> <li class="nav-item nav-item-0"><a href=../../index.html>Blackhole 2.1.19 documentation</a> &#187;</li> <li class="nav-item nav-item-1"><a href=../index.html accesskey=U>Module code</a> &#187;</li> <li class="nav-item nav-item-this"><a href>blackhole.config</a></li> </ul> </div> <div class=container-wrapper> <div id=mobile-toggle> <a href=#><span class="glyphicon glyphicon-align-justify" aria-hidden=true></span></a> </div> <div id=left-column> <div class=sphinxsidebar><a href="
    ../../index.html" class=text-logo>Blackhole</a><div class=sidebar-block> <div class=sidebar-wrapper> <h2>Table Of Contents</h2> </div> <div class=sidebar-toc> <ul><li class=toctree-l1><a class="reference internal" href=../../overview.html>Overview</a></li><li class=toctree-l1><a class="reference internal" href=../../configuration.html>Configuration</a></li><li class=toctree-l1><a class="reference internal" href=../../communicating-with-blackhole.html>Communicating with Blackhole</a></li><li class=toctree-l1><a class="reference internal" href=../../dynamic-responses.html>Dynamic responses</a></li><li class=toctree-l1><a class="reference internal" href=../../dynamic-switches.html>Dynamic Switches</a></li><li class=toctree-l1><a class="reference internal" href=../../api.html>API</a></li></ul> </div></div><div class=sidebar-block> <div class=sidebar-wrapper> <div id=main-search> <form class=form-inline action=../../search.html method=GET role=form> <div class=input-group> <input name=q type=text class=form-control placeholder=Search...> </div> <input type=hidden name=check_keywords value=yes> <input type=hidden name=area value=default> </form> </div> </div></div> </div> </div> <div id=right-column> <div role=navigation aria-label="breadcrumbs navigation"> <ol class=breadcrumb> <li><a href=../../index.html>Docs</a></li> <li><a href=../index.html>Module code</a></li> <li>blackhole.config</li> </ol> </div> <div class="document clearer body"> <h1>Source code for blackhole.config</h1><div class=highlight><pre>
<span></span><span class=c1># -*- coding: utf-8 -*-</span>

<span class=c1># (The MIT License)</span>
<span class=c1>#</span>
<span class=c1># Copyright (c) 2013-2021 Kura</span>
<span class=c1>#</span>
<span class=c1># Permission is hereby granted, free of charge, to any person obtaining a copy</span>
<span class=c1># of this software and associated documentation files (the &#39;Software&#39;), to deal</span>
<span class=c1># in the Software without restriction, including without limitation the rights</span>
<span class=c1># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class=c1># copies of the Software, and to permit persons to whom the Software is</span>
<span class=c1># furnished to do so, subject to the following conditions:</span>
<span class=c1>#</span>
<span class=c1># The above copyright notice and this permission notice shall be included in</span>
<span class=c1># all copies or substantial portions of the Software.</span>
<span class=c1>#</span>
<span class=c1># THE SOFTWARE IS PROVIDED &#39;AS IS&#39;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span>
<span class=c1># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span>
<span class=c1># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span>
<span class=c1># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span>
<span class=c1># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span>
<span class=c1># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span>
<span class=c1># SOFTWARE.</span>

<span class=sd>&quot;&quot;&quot;Configuration structure and functionality for testing config validity.&quot;&quot;&quot;</span>


<span class=kn>import</span> <span class=nn>argparse</span>
<span class=kn>import</span> <span class=nn>getpass</span>
<span class=kn>import</span> <span class=nn>grp</span>
<span class=kn>import</span> <span class=nn>inspect</span>
<span class=kn>import</span> <span class=nn>logging</span>
<span class=kn>import</span> <span class=nn>multiprocessing</span>
<span class=kn>import</span> <span class=nn>os</span>
<span class=kn>import</span> <span class=nn>pathlib</span>
<span class=kn>import</span> <span class=nn>pwd</span>
<span class=kn>import</span> <span class=nn>socket</span>
<span class=kn>import</span> <span class=nn>tempfile</span>

<span class=kn>from</span> <span class=nn>.exceptions</span> <span class=kn>import</span> <span class=n>ConfigException</span>
<span class=kn>from</span> <span class=nn>.utils</span> <span class=kn>import</span> <span class=n>Singleton</span><span class=p>,</span> <span class=n>get_version</span><span class=p>,</span> <span class=n>mailname</span>


<span class=n>__all__</span> <span class=o>=</span> <span class=p>(</span><span class=s2>&quot;parse_cmd_args&quot;</span><span class=p>,</span> <span class=s2>&quot;warn_options&quot;</span><span class=p>,</span> <span class=s2>&quot;config_test&quot;</span><span class=p>,</span> <span class=s2>&quot;Config&quot;</span><span class=p>)</span>
<span class=sd>&quot;&quot;&quot;Tuple all the things.&quot;&quot;&quot;</span>


<div class=viewcode-block id=parse_cmd_args><a class=viewcode-back href=../../api-config.html#blackhole.config.parse_cmd_args>[docs]</a><span class=k>def</span> <span class=nf>parse_cmd_args</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Parse arguments from the command line.</span>

<span class=sd>    https://kura.gg/blackhole/configuration.html#command-line-options</span>

<span class=sd>    :param list args: Command line arguments.</span>
<span class=sd>    :returns: Parsed command line arguments.</span>
<span class=sd>    :rtype: :py:class:`argparse.Namespace`</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>ls_help</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;Disable ssl.OP_SINGLE_DH_USE and ssl.OP_SINGLE_ECDH_USE. &quot;</span>
        <span class=s2>&quot;Reduces CPU overhead at the expense of security -- Don&#39;t &quot;</span>
        <span class=s2>&quot;use this option unless you really need to.&quot;</span>
    <span class=p>)</span>

    <span class=n>description</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;Blackhole is an MTA (mail transfer agent) that &quot;</span>
        <span class=s2>&quot;(figuratively) pipes all mail to /dev/null. Blackhole is &quot;</span>
        <span class=s2>&quot;built on top of asyncio and utilises async def and await &quot;</span>
        <span class=s2>&quot;statements available in Python 3.5 and above.&quot;</span>
    <span class=p>)</span>

    <span class=n>epilog</span> <span class=o>=</span> <span class=p>(</span>
        <span class=s2>&quot;An explanation of all command line and all configuration &quot;</span>
        <span class=s2>&quot;options is provided here -- &quot;</span>
        <span class=s2>&quot;https://kura.gg/blackhole/configuration.html&quot;</span>
    <span class=p>)</span>

    <span class=n>parser</span> <span class=o>=</span> <span class=n>argparse</span><span class=o>.</span><span class=n>ArgumentParser</span><span class=p>(</span>
        <span class=s2>&quot;blackhole&quot;</span><span class=p>,</span>
        <span class=n>description</span><span class=o>=</span><span class=n>description</span><span class=p>,</span>
        <span class=n>epilog</span><span class=o>=</span><span class=n>epilog</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-v&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--version&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;version&quot;</span><span class=p>,</span>
        <span class=n>version</span><span class=o>=</span><span class=n>get_version</span><span class=p>(),</span>
    <span class=p>)</span>
    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-c&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--conf&quot;</span><span class=p>,</span>
        <span class=nb>type</span><span class=o>=</span><span class=nb>str</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;config_file&quot;</span><span class=p>,</span>
        <span class=n>metavar</span><span class=o>=</span><span class=s2>&quot;FILE&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=s2>&quot;override the default configuration options&quot;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>group</span> <span class=o>=</span> <span class=n>parser</span><span class=o>.</span><span class=n>add_mutually_exclusive_group</span><span class=p>()</span>
    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-t&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--test&quot;</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;test&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;store_true&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=s2>&quot;perform a configuration test&quot;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-d&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--debug&quot;</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;debug&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;store_true&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=s2>&quot;enable debugging mode&quot;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-b&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--background&quot;</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;background&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;store_true&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=s2>&quot;run in the background&quot;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>group</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-q&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--quiet&quot;</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;quiet&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;store_true&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=s2>&quot;Suppress warnings&quot;</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=n>parser</span><span class=o>.</span><span class=n>add_argument</span><span class=p>(</span>
        <span class=s2>&quot;-ls&quot;</span><span class=p>,</span>
        <span class=s2>&quot;--less-secure&quot;</span><span class=p>,</span>
        <span class=n>dest</span><span class=o>=</span><span class=s2>&quot;less_secure&quot;</span><span class=p>,</span>
        <span class=n>action</span><span class=o>=</span><span class=s2>&quot;store_true&quot;</span><span class=p>,</span>
        <span class=n>help</span><span class=o>=</span><span class=n>ls_help</span><span class=p>,</span>
    <span class=p>)</span>
    <span class=k>return</span> <span class=n>parser</span><span class=o>.</span><span class=n>parse_args</span><span class=p>(</span><span class=n>args</span><span class=p>)</span></div>


<div class=viewcode-block id=warn_options><a class=viewcode-back href=../../api-config.html#blackhole.config.warn_options>[docs]</a><span class=k>def</span> <span class=nf>warn_options</span><span class=p>(</span><span class=n>config</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Warn the user when using certain options.</span>

<span class=sd>    :param Config config: The configuration.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&quot;blackhole.warnings&quot;</span><span class=p>)</span>
    <span class=k>if</span> <span class=n>config</span><span class=o>.</span><span class=n>args</span><span class=o>.</span><span class=n>less_secure</span><span class=p>:</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
            <span class=s2>&quot;Using -ls or --less-secure reduces security on &quot;</span>
            <span class=s2>&quot;SSL/TLS connections.&quot;</span><span class=p>,</span>
        <span class=p>)</span>
    <span class=k>if</span> <span class=ow>not</span> <span class=n>config</span><span class=o>.</span><span class=n>tls_dhparams</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
            <span class=s2>&quot;TLS is enabled but no Diffie Hellman ephemeral &quot;</span>
            <span class=s2>&quot;parameters file was provided.&quot;</span><span class=p>,</span>
        <span class=p>)</span>
    <span class=n>_compare_uid_and_gid</span><span class=p>(</span><span class=n>config</span><span class=p>)</span></div>


<div class=viewcode-block id=config_test><a class=viewcode-back href=../../api-config.html#blackhole.config.config_test>[docs]</a><span class=k>def</span> <span class=nf>config_test</span><span class=p>(</span><span class=n>args</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Test the validity of the configuration file content.</span>

<span class=sd>    :param argparse.Namespace args: Parsed arguments.</span>
<span class=sd>    :raises SystemExit: Exit code :py:obj:`os.EX_OK` when config is valid</span>
<span class=sd>                        or :py:obj:`os.EX_USAGE` when config is invalid.</span>

<span class=sd>    .. note::</span>

<span class=sd>       Problems with the configuration will be written to the console using</span>
<span class=sd>       the :py:mod:`logging` module.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&quot;blackhole.config.test&quot;</span><span class=p>)</span>
    <span class=n>logger</span><span class=o>.</span><span class=n>setLevel</span><span class=p>(</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>conf</span> <span class=o>=</span> <span class=n>Config</span><span class=p>(</span><span class=n>args</span><span class=o>.</span><span class=n>config_file</span><span class=p>)</span><span class=o>.</span><span class=n>load</span><span class=p>()</span><span class=o>.</span><span class=n>test</span><span class=p>()</span>
        <span class=n>conf</span><span class=o>.</span><span class=n>args</span> <span class=o>=</span> <span class=n>args</span>
    <span class=k>except</span> <span class=n>ConfigException</span><span class=p>:</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>critical</span><span class=p>(</span><span class=s2>&quot;Config error&quot;</span><span class=p>)</span>
        <span class=k>raise</span> <span class=ne>SystemExit</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>EX_USAGE</span><span class=p>)</span>
    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;blackhole: </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>config_file</span><span class=si>}</span><span class=s2> syntax is OK.&quot;</span><span class=p>)</span>
    <span class=n>logger</span><span class=o>.</span><span class=n>info</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;blackhole: </span><span class=si>{</span><span class=n>args</span><span class=o>.</span><span class=n>config_file</span><span class=si>}</span><span class=s2> test was successful.&quot;</span><span class=p>)</span>
    <span class=n>warn_options</span><span class=p>(</span><span class=n>conf</span><span class=p>)</span>
    <span class=k>raise</span> <span class=ne>SystemExit</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>EX_OK</span><span class=p>)</span></div>


<div class=viewcode-block id=_compare_uid_and_gid><a class=viewcode-back href=../../api-config.html#blackhole.config._compare_uid_and_gid>[docs]</a><span class=k>def</span> <span class=nf>_compare_uid_and_gid</span><span class=p>(</span><span class=n>config</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Compare the current user and group and conf settings.</span>

<span class=sd>    :param Config config: The configuration.</span>
<span class=sd>    &quot;&quot;&quot;</span>
    <span class=n>logger</span> <span class=o>=</span> <span class=n>logging</span><span class=o>.</span><span class=n>getLogger</span><span class=p>(</span><span class=s2>&quot;blackhole.warnings&quot;</span><span class=p>)</span>
    <span class=n>uid</span><span class=p>,</span> <span class=n>gid</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>getuid</span><span class=p>(),</span> <span class=n>os</span><span class=o>.</span><span class=n>getgid</span><span class=p>()</span>
    <span class=n>user</span><span class=p>,</span> <span class=n>group</span> <span class=o>=</span> <span class=n>config</span><span class=o>.</span><span class=n>user</span><span class=p>,</span> <span class=n>config</span><span class=o>.</span><span class=n>group</span>
    <span class=k>if</span> <span class=p>(</span><span class=n>uid</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>gid</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span> <span class=ow>and</span> <span class=p>(</span><span class=n>user</span> <span class=o>==</span> <span class=s2>&quot;root&quot;</span> <span class=ow>and</span> <span class=n>group</span> <span class=o>==</span> <span class=s2>&quot;root&quot;</span><span class=p>):</span>
        <span class=n>logger</span><span class=o>.</span><span class=n>warning</span><span class=p>(</span>
            <span class=s2>&quot;It is unsafe to run Blackhole as root without setting &quot;</span>
            <span class=s2>&quot;a user and group for privilege separation.&quot;</span><span class=p>,</span>
        <span class=p>)</span></div>


<div class=viewcode-block id=Config><a class=viewcode-back href=../../api-config.html#blackhole.config.Config>[docs]</a><span class=k>class</span> <span class=nc>Config</span><span class=p>(</span><span class=n>metaclass</span><span class=o>=</span><span class=n>Singleton</span><span class=p>):</span>
    <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>    Configuration module.</span>

<span class=sd>    Default values are provided as well as self-test functionality</span>
<span class=sd>    to sanity check configuration.</span>

<span class=sd>    https://kura.gg/blackhole/configuration.html#configuration-options</span>
<span class=sd>    &quot;&quot;&quot;</span>

    <span class=n>args</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=sd>&quot;&quot;&quot;Arguments parsed from the command line.&quot;&quot;&quot;</span>

    <span class=n>config_file</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=sd>&quot;&quot;&quot;A file containing configuration values.&quot;&quot;&quot;</span>

    <span class=n>_workers</span> <span class=o>=</span> <span class=mi>1</span>
    <span class=n>_listen</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>_tls_listen</span> <span class=o>=</span> <span class=p>[]</span>
    <span class=n>_user</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_group</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_timeout</span> <span class=o>=</span> <span class=mi>60</span>
    <span class=n>_tls_key</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_tls_cert</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_tls_dhparams</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_pidfile</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>tempfile</span><span class=o>.</span><span class=n>gettempdir</span><span class=p>(),</span> <span class=s2>&quot;blackhole.pid&quot;</span><span class=p>)</span>
    <span class=n>_delay</span> <span class=o>=</span> <span class=kc>None</span>
    <span class=n>_mode</span> <span class=o>=</span> <span class=s2>&quot;accept&quot;</span>
    <span class=n>_max_message_size</span> <span class=o>=</span> <span class=mi>512000</span>
    <span class=n>_dynamic_switch</span> <span class=o>=</span> <span class=kc>None</span>

    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>config_file</span><span class=o>=</span><span class=kc>None</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Initialise the configuration.</span>

<span class=sd>        :param str config_file: The configuration file path. Default: ``None``</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>config_file</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>config_file</span> <span class=o>=</span> <span class=n>config_file</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>user</span> <span class=o>=</span> <span class=n>getpass</span><span class=o>.</span><span class=n>getuser</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>group</span> <span class=o>=</span> <span class=n>grp</span><span class=o>.</span><span class=n>getgrgid</span><span class=p>(</span><span class=n>os</span><span class=o>.</span><span class=n>getgid</span><span class=p>())</span><span class=o>.</span><span class=n>gr_name</span>
        <span class=c1># this has to be cached here due to the socket.getfqdn call failing</span>
        <span class=c1># in os.fork</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>mailname</span> <span class=o>=</span> <span class=n>mailname</span><span class=p>()</span>

<div class=viewcode-block id=Config.load><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.load>[docs]</a>    <span class=k>def</span> <span class=nf>load</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Load the configuration file and parse.</span>

<span class=sd>        :raises ConfigException: When the configuration is invalid.</span>
<span class=sd>        :returns: :class:`Config`.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Spaces, single and double quotes will be stripped. Lines beginning</span>
<span class=sd>           # will be ignored. # comments in-line will be stripped out and</span>
<span class=sd>           ignored.</span>

<span class=sd>           i.e.</span>

<span class=sd>           # listen = :1025, :::1025   -&gt;</span>
<span class=sd>           listen = :25, :::25  # IPv4 &amp; IPv6   -&gt;   listen = :25, :::25</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>config_file</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=bp>self</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>access</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config_file</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>R_OK</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Config file does not exist or is not readable.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>config_file</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>_conf_file</span><span class=p>:</span>
            <span class=k>for</span> <span class=n>line</span> <span class=ow>in</span> <span class=n>_conf_file</span><span class=o>.</span><span class=n>readlines</span><span class=p>():</span>
                <span class=n>line</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
                <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;#&quot;</span><span class=p>):</span>
                    <span class=k>continue</span>
                <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;&quot;</span><span class=p>:</span>
                    <span class=k>continue</span>
                <span class=k>if</span> <span class=s2>&quot;#&quot;</span> <span class=ow>in</span> <span class=n>line</span><span class=p>:</span>
                    <span class=n>line</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;#&quot;</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span>
                <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=p>)</span> <span class=o>&gt;=</span> <span class=mi>1</span><span class=p>:</span>
                    <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>line</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
                    <span class=n>key</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>key</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=n>value</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>validate_option</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
                    <span class=n>value</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s1>&#39;&quot;&#39;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=s2>&quot;&#39;&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span>
                    <span class=nb>setattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>,</span> <span class=n>value</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=bp>self</span><span class=o>.</span><span class=n>validate_option</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
        <span class=k>return</span> <span class=bp>self</span></div>

<div class=viewcode-block id=Config.validate_option><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.validate_option>[docs]</a>    <span class=k>def</span> <span class=nf>validate_option</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>key</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate config option is actually... valid...</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#configuration-options</span>

<span class=sd>        :param str key: Configuration option.</span>
<span class=sd>        :raises ConfigException: When an invalid option is configured.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>key</span> <span class=o>==</span> <span class=s2>&quot;&quot;</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>attributes</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>getmembers</span><span class=p>(</span>
            <span class=bp>self</span><span class=p>,</span>
            <span class=k>lambda</span> <span class=n>a</span><span class=p>:</span> <span class=ow>not</span> <span class=p>(</span><span class=n>inspect</span><span class=o>.</span><span class=n>isroutine</span><span class=p>(</span><span class=n>a</span><span class=p>)),</span>
        <span class=p>)</span>
        <span class=n>attrs</span> <span class=o>=</span> <span class=p>[</span>
            <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>][</span><span class=mi>1</span><span class=p>:]</span>
            <span class=k>for</span> <span class=n>a</span> <span class=ow>in</span> <span class=n>attributes</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;__&quot;</span><span class=p>)</span> <span class=ow>and</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>endswith</span><span class=p>(</span><span class=s2>&quot;__&quot;</span><span class=p>))</span>
            <span class=ow>and</span> <span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;_&quot;</span><span class=p>)</span>
        <span class=p>]</span>
        <span class=k>if</span> <span class=n>key</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>attrs</span><span class=p>:</span>
            <span class=n>_attrs</span> <span class=o>=</span> <span class=s2>&quot;&#39;, &#39;&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>attrs</span><span class=p>[:</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
            <span class=n>valid_attrs</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;&#39;</span><span class=si>{</span><span class=n>_attrs</span><span class=si>}</span><span class=s2>&#39; and &#39;</span><span class=si>{</span><span class=n>attrs</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&#39;&quot;</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;Invalid configuration option &#39;</span><span class=si>{</span><span class=n>key</span><span class=si>}</span><span class=s2>&#39;.</span><span class=se>\n\n</span><span class=s2>Valid options &quot;</span>
                <span class=sa>f</span><span class=s2>&quot;are: </span><span class=si>{</span><span class=n>valid_attrs</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>workers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        How many workers to spawn to handle incoming connections.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#workers</span>

<span class=sd>        :returns: Number of workers. Default: ``1``</span>
<span class=sd>        :rtype: :py:obj:`int`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Default value is 1.</span>

<span class=sd>           A supervisor process will always exist separately from the workers.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_workers</span><span class=p>)</span> <span class=ow>or</span> <span class=mi>1</span>

    <span class=nd>@workers</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>workers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>workers</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_workers</span> <span class=o>=</span> <span class=n>workers</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>listen</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Address, port and socket family.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#listen</span>

<span class=sd>        :returns: Listeners.</span>
<span class=sd>        :rtype: :py:obj:`list`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Default IPv4:</span>

<span class=sd>               [(&#39;127.0.0.1&#39;, 25, socket.AF_INET,</span>
<span class=sd>                (&#39;127.0.0.1&#39;, 587, socket.AF_INET), ]</span>

<span class=sd>           Default IPv6:</span>

<span class=sd>               [(&#39;127.0.0.1&#39;, 25, socket.AF_INET),</span>
<span class=sd>                (&#39;127.0.0.1&#39;, 587, socket.AF_INET), ]</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>ipv4</span> <span class=o>=</span> <span class=p>[</span>
            <span class=p>(</span><span class=s2>&quot;127.0.0.1&quot;</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=p>{}),</span>
            <span class=p>(</span><span class=s2>&quot;127.0.0.1&quot;</span><span class=p>,</span> <span class=mi>587</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span><span class=p>,</span> <span class=p>{}),</span>
        <span class=p>]</span>
        <span class=n>ipv6</span> <span class=o>=</span> <span class=p>[</span>
            <span class=p>(</span><span class=s2>&quot;::&quot;</span><span class=p>,</span> <span class=mi>25</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET6</span><span class=p>,</span> <span class=p>{}),</span>
            <span class=p>(</span><span class=s2>&quot;::&quot;</span><span class=p>,</span> <span class=mi>587</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET6</span><span class=p>,</span> <span class=p>{}),</span>
        <span class=p>]</span>
        <span class=n>default</span> <span class=o>=</span> <span class=n>ipv4</span> <span class=o>+</span> <span class=n>ipv6</span> <span class=k>if</span> <span class=n>socket</span><span class=o>.</span><span class=n>has_ipv6</span> <span class=k>else</span> <span class=n>ipv4</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_listen</span> <span class=ow>or</span> <span class=n>default</span>

    <span class=nd>@listen</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>listen</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addrs</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_listen</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_listeners</span><span class=p>(</span><span class=n>addrs</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tls_listen</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Address and port and socket family for SSL/TLS connections.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#tls-listen</span>

<span class=sd>        :returns: TLS listeners. Default: ``[]``</span>
<span class=sd>        :rtype: :py:obj:`list`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tls_listen</span> <span class=ow>or</span> <span class=p>[]</span>

    <span class=nd>@tls_listen</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>tls_listen</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addrs</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_tls_listen</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_listeners</span><span class=p>(</span><span class=n>addrs</span><span class=p>)</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>user</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        UNIX user.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#user</span>

<span class=sd>        :returns: User name.</span>
<span class=sd>        :rtype: :py:obj:`str`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to the current user.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_user</span>

    <span class=nd>@user</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>user</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>user</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_user</span> <span class=o>=</span> <span class=n>user</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>group</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        UNIX group.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#group</span>

<span class=sd>        :returns: Group name.</span>
<span class=sd>        :rtype: :py:obj:`str`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to the current group.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_group</span>

    <span class=nd>@group</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>group</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>group</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_group</span> <span class=o>=</span> <span class=n>group</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Timeout in seconds.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#timeout</span>

<span class=sd>        :returns: Timeout in seconds. Default: ``60``</span>
<span class=sd>        :rtype: :py:obj:`int`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to 60 seconds.</span>
<span class=sd>           Cannot be more 180 seconds for security (denial of service).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_timeout</span><span class=p>)</span>

    <span class=nd>@timeout</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>timeout</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_timeout</span> <span class=o>=</span> <span class=n>timeout</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tls_key</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        TLS key file.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#tls-key</span>

<span class=sd>        :returns: Path to a TLS key file. Default: ``None``</span>
<span class=sd>        :rtype: :py:obj:`str`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tls_key</span>

    <span class=nd>@tls_key</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>tls_key</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tls_key</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tls_key</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_tls_key</span> <span class=o>=</span> <span class=n>tls_key</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tls_cert</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        TLS certificate file.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#tls-cert</span>

<span class=sd>        :returns: Path to a TLS certificate. Default: ``None``</span>
<span class=sd>        :rtype: :py:obj:`str`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tls_cert</span>

    <span class=nd>@tls_cert</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>tls_cert</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tls_cert</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tls_cert</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_tls_cert</span> <span class=o>=</span> <span class=n>tls_cert</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>tls_dhparams</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Diffie Hellman ephemeral parameters.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#tls-dhparams</span>

<span class=sd>        :returns: Path to a file containing dhparams. Default: ``None``</span>
<span class=sd>        :rtype: :py:obj:`str`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_tls_dhparams</span>

    <span class=nd>@tls_dhparams</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>tls_dhparams</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>tls_dhparams</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>tls_dhparams</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_tls_dhparams</span> <span class=o>=</span> <span class=n>tls_dhparams</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>pidfile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Path to store the pid.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#pidfile</span>

<span class=sd>        :returns: Path to a pid file. Default: ``/tmp/blackhole.pid``.</span>
<span class=sd>        :rtype: :py:obj:`str`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_pidfile</span>

    <span class=nd>@pidfile</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>pidfile</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pidfile</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>pidfile</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_pidfile</span> <span class=o>=</span> <span class=n>pidfile</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>delay</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Delay in seconds.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#delay</span>

<span class=sd>        :returns: Delay in seconds. Default: ``None``</span>
<span class=sd>        :rtype: :py:obj:`int` or :py:obj:`None`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to :py:obj:`None`.</span>
<span class=sd>           Cannot be higher than 60 seconds for security (denial of service).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_delay</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_delay</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=nd>@delay</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>delay</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>delay</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_delay</span> <span class=o>=</span> <span class=n>delay</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>mode</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Mode with which to respond.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#mode</span>

<span class=sd>        :returns: A response mode. Default: ``accept``.</span>
<span class=sd>        :rtype: :py:obj:`str`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to &#39;accept&#39;.</span>
<span class=sd>           Options: &#39;accept&#39;, &#39;bounce&#39; and &#39;random&#39;.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_mode</span>

    <span class=nd>@mode</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>mode</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mode</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_mode</span> <span class=o>=</span> <span class=n>mode</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>max_message_size</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Maximum size, in bytes, of a message.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#max-message-size</span>

<span class=sd>        :returns: Maximum message size in bytes. Default: ``512000``.</span>
<span class=sd>        :rtype: :py:obj:`int`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Default 512000 bytes (512 KB).</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_max_message_size</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_max_message_size</span><span class=p>)</span>
        <span class=k>return</span> <span class=kc>None</span>

    <span class=nd>@max_message_size</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>max_message_size</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>size</span><span class=p>):</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_max_message_size</span> <span class=o>=</span> <span class=n>size</span>

    <span class=nd>@property</span>
    <span class=k>def</span> <span class=nf>dynamic_switch</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Enable or disable dynamic switches.</span>

<span class=sd>        https://kura.gg/blackhole/configuration.html#dynamic-switch</span>

<span class=sd>        :returns: Whether dynamic switches are enabled or not. Default:</span>
<span class=sd>                  ``True``.</span>
<span class=sd>        :rtype: :py:obj:`bool`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Allowed values are :py:obj:`True` and :py:obj:`False`.</span>
<span class=sd>           Default: :py:obj:`True`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>True</span>
        <span class=k>return</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span>

    <span class=nd>@dynamic_switch</span><span class=o>.</span><span class=n>setter</span>
    <span class=k>def</span> <span class=nf>dynamic_switch</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>switch</span><span class=p>):</span>
        <span class=k>if</span> <span class=n>switch</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;false&quot;</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=k>elif</span> <span class=n>switch</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=o>==</span> <span class=s2>&quot;true&quot;</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span> <span class=o>=</span> <span class=kc>True</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>switch</span><span class=si>}</span><span class=s2> is not valid. Options are true or false.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_convert_port</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>port</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Convert a port from the configuration files&#39; string to an integer.</span>

<span class=sd>        :param str port: A port number.</span>
<span class=sd>        :type port: :py:obj:`str`</span>
<span class=sd>        :raises ConfigException: If an invalid port number if provided.</span>
<span class=sd>        :returns: A port number.</span>
<span class=sd>        :rtype: :py:obj:`int`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=k>return</span> <span class=nb>int</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2> is not a valid port number.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>

    <span class=k>def</span> <span class=nf>_listeners</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>listeners</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Convert listeners lines from the configuration to usable values.</span>

<span class=sd>        :param str listeners: A list of addresses and ports, separated by</span>
<span class=sd>                              commas.</span>
<span class=sd>                              -- e.g. &#39;127.0.0.1:25, 10.0.0.1:25, :25, :::25&#39;</span>
<span class=sd>        :returns: List of addresses and sockets to listen on.</span>
<span class=sd>        :rtype: :py:obj:`list` or :py:obj:`None`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>clisteners</span> <span class=o>=</span> <span class=p>[]</span>
        <span class=n>_listeners</span> <span class=o>=</span> <span class=n>listeners</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>)</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>_listeners</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>for</span> <span class=n>listener</span> <span class=ow>in</span> <span class=n>_listeners</span><span class=p>:</span>
            <span class=n>listener</span> <span class=o>=</span> <span class=n>listener</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
            <span class=n>parts</span> <span class=o>=</span> <span class=n>listener</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot; &quot;</span><span class=p>)</span>
            <span class=n>addr_port</span> <span class=o>=</span> <span class=n>parts</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
            <span class=n>port</span> <span class=o>=</span> <span class=n>addr_port</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;:&quot;</span><span class=p>)[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
            <span class=n>addr</span> <span class=o>=</span> <span class=n>addr_port</span><span class=o>.</span><span class=n>replace</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;:</span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=s2>&quot;&quot;</span><span class=p>)</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
            <span class=n>family</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET</span>
            <span class=k>if</span> <span class=s2>&quot;:&quot;</span> <span class=ow>in</span> <span class=n>addr</span><span class=p>:</span>
                <span class=n>family</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET6</span>
            <span class=n>flags</span> <span class=o>=</span> <span class=p>{}</span>
            <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>parts</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>1</span><span class=p>:</span>
                <span class=n>flags</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>create_flags</span><span class=p>(</span><span class=n>parts</span><span class=p>[</span><span class=mi>1</span><span class=p>:])</span>
            <span class=n>host</span> <span class=o>=</span> <span class=p>(</span><span class=n>addr</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_convert_port</span><span class=p>(</span><span class=n>port</span><span class=p>),</span> <span class=n>family</span><span class=p>,</span> <span class=n>flags</span><span class=p>)</span>
            <span class=n>clisteners</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>host</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>clisteners</span>

<div class=viewcode-block id=Config.flags_from_listener><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.flags_from_listener>[docs]</a>    <span class=k>def</span> <span class=nf>flags_from_listener</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>addr</span><span class=p>,</span> <span class=n>port</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Get a list of flags defined for the provided listener.</span>

<span class=sd>        Scope: ``listen``, ``tls_listen``.</span>

<span class=sd>        :param str addr: The listener host address.</span>
<span class=sd>        :param int port: The listener port.</span>
<span class=sd>        :returns: Flags defined for this socket. Default: ``{}``.</span>
<span class=sd>        :rtype: :py:obj:`dict`</span>

<span class=sd>        .. note::</span>

<span class=sd>           If multiple modes or delays are listed in a single listener, the</span>
<span class=sd>           last definition will be used:</span>

<span class=sd>           ``listen = :25 mode=bounce mode=random``  -&gt;  ``mode=random``</span>

<span class=sd>           A mode and delay can be used in tandum:</span>

<span class=sd>           ``listen = :25 mode=bounce delay=10``</span>

<span class=sd>           The delay can also be specified as a range:</span>

<span class=sd>           ``listen = :25 delay=5-10``</span>

<span class=sd>           Using a delay range will cause the server to choose a random value</span>
<span class=sd>           within that range per connection.</span>

<span class=sd>           Mode and delay can be defined for each address/port in a listen</span>
<span class=sd>           directive:</span>

<span class=sd>           ``listen = :25 mode=bounce, :::25 delay=10, :587 mode=random``</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>addr</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;127.0.0.1&quot;</span><span class=p>,</span> <span class=s2>&quot;0.0.0.0&quot;</span><span class=p>):</span>  <span class=c1># nosec</span>
            <span class=n>addr</span> <span class=o>=</span> <span class=s2>&quot;&quot;</span>
        <span class=k>elif</span> <span class=n>addr</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;::1&quot;</span><span class=p>,):</span>
            <span class=n>addr</span> <span class=o>=</span> <span class=s2>&quot;::&quot;</span>
        <span class=n>listeners</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>listen</span> <span class=o>+</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span>
        <span class=k>for</span> <span class=n>laddr</span><span class=p>,</span> <span class=n>lport</span><span class=p>,</span> <span class=n>__</span><span class=p>,</span> <span class=n>lflags</span> <span class=ow>in</span> <span class=n>listeners</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>laddr</span> <span class=o>==</span> <span class=n>addr</span> <span class=ow>and</span> <span class=n>lport</span> <span class=o>==</span> <span class=n>port</span><span class=p>:</span>
                <span class=k>return</span> <span class=n>lflags</span>
        <span class=k>return</span> <span class=p>{}</span></div>

<div class=viewcode-block id=Config.create_flags><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.create_flags>[docs]</a>    <span class=k>def</span> <span class=nf>create_flags</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>parts</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create a set of flags from a listener directive.</span>

<span class=sd>        :param list parts: Parts of the listener definition.</span>
<span class=sd>        :returns: Flags for a listener. Default: ``{}``.</span>
<span class=sd>        :rtype: :py:obj:`dict`</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>flags</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=k>for</span> <span class=n>part</span> <span class=ow>in</span> <span class=n>parts</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>part</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
                <span class=n>flag</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>part</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;=&quot;</span><span class=p>)</span>
                <span class=n>flag</span><span class=p>,</span> <span class=n>value</span> <span class=o>=</span> <span class=n>flag</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=n>value</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
                <span class=k>if</span> <span class=n>flag</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;mode&quot;</span><span class=p>,</span> <span class=s2>&quot;delay&quot;</span><span class=p>):</span>
                    <span class=k>if</span> <span class=n>flag</span> <span class=o>==</span> <span class=s2>&quot;mode&quot;</span><span class=p>:</span>
                        <span class=n>flags</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_flag_mode</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
                    <span class=k>elif</span> <span class=n>flag</span> <span class=o>==</span> <span class=s2>&quot;delay&quot;</span><span class=p>:</span>
                        <span class=n>flags</span><span class=o>.</span><span class=n>update</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_flag_delay</span><span class=p>(</span><span class=n>flag</span><span class=p>,</span> <span class=n>value</span><span class=p>))</span>
        <span class=k>return</span> <span class=n>flags</span></div>

    <span class=k>def</span> <span class=nf>_flag_mode</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>flag</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create a flag for the mode directive.</span>

<span class=sd>        :param str flag: The flag name.</span>
<span class=sd>        :param str value: The value of the flag.</span>
<span class=sd>        :returns: Mode flag for a listener.</span>
<span class=sd>        :rtype: :py:obj:`dict`</span>
<span class=sd>        :raises ConfigException: If an invalid mode is provided.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>value</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;accept&quot;</span><span class=p>,</span> <span class=s2>&quot;bounce&quot;</span><span class=p>,</span> <span class=s2>&quot;random&quot;</span><span class=p>):</span>
            <span class=k>return</span> <span class=p>{</span><span class=n>flag</span><span class=p>:</span> <span class=n>value</span><span class=p>}</span>
        <span class=k>else</span><span class=p>:</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;&#39;</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>&#39; is not a valid mode. Valid options &quot;</span>
                <span class=s2>&quot;are: &#39;accept&#39;, &#39;bounce&#39; and &#39;random&#39;.&quot;</span><span class=p>,</span>
            <span class=p>)</span>

    <span class=k>def</span> <span class=nf>_flag_delay</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>flag</span><span class=p>,</span> <span class=n>value</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Create a delay flag, delay can be an int or a range.</span>

<span class=sd>        :param str flag: The flag name.</span>
<span class=sd>        :param str value: The value of the flag.</span>
<span class=sd>        :returns: Delay flag for a listener.</span>
<span class=sd>        :rtype: :py:obj:`dict`</span>
<span class=sd>        :raises ConfigException: If an invalid delay is provided.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=n>value</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>value</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span> <span class=ow>and</span> <span class=nb>int</span><span class=p>(</span><span class=n>value</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>60</span><span class=p>:</span>
                <span class=k>return</span> <span class=p>{</span><span class=n>flag</span><span class=p>:</span> <span class=n>value</span><span class=p>}</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span>
                    <span class=sa>f</span><span class=s2>&quot;&#39;</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>&#39; is not a valid delay. Delay is &quot;</span>
                    <span class=s2>&quot;in seconds and must be below 60.&quot;</span><span class=p>,</span>
                <span class=p>)</span>
        <span class=k>if</span> <span class=n>value</span><span class=o>.</span><span class=n>count</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=p>)</span> <span class=o>==</span> <span class=mi>1</span><span class=p>:</span>
            <span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=o>=</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=s2>&quot;-&quot;</span><span class=p>)</span>
            <span class=n>start</span><span class=p>,</span> <span class=n>end</span> <span class=o>=</span> <span class=n>start</span><span class=o>.</span><span class=n>strip</span><span class=p>(),</span> <span class=n>end</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>
            <span class=k>if</span> <span class=p>(</span>
                <span class=n>start</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span>
                <span class=ow>and</span> <span class=n>end</span><span class=o>.</span><span class=n>isdigit</span><span class=p>()</span>
                <span class=ow>and</span> <span class=nb>int</span><span class=p>(</span><span class=n>start</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>60</span>
                <span class=ow>and</span> <span class=nb>int</span><span class=p>(</span><span class=n>end</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>60</span>
                <span class=ow>and</span> <span class=nb>int</span><span class=p>(</span><span class=n>end</span><span class=p>)</span> <span class=o>&gt;</span> <span class=nb>int</span><span class=p>(</span><span class=n>start</span><span class=p>)</span>
            <span class=p>):</span>
                <span class=k>return</span> <span class=p>{</span><span class=n>flag</span><span class=p>:</span> <span class=p>(</span><span class=n>start</span><span class=p>,</span> <span class=n>end</span><span class=p>)}</span>
        <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span>
            <span class=sa>f</span><span class=s2>&quot;&#39;</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>&#39; is not a valid delay value. It must be &quot;</span>
            <span class=s2>&quot;either a single value or a range i.e. 5-10 and &quot;</span>
            <span class=s2>&quot;must be less than 60.&quot;</span><span class=p>,</span>
        <span class=p>)</span>

<div class=viewcode-block id=Config.test><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test>[docs]</a>    <span class=k>def</span> <span class=nf>test</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sa>r</span><span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Test configuration validity.</span>

<span class=sd>        :returns: The configuration object.</span>
<span class=sd>        :rtype: :class:`Config`</span>

<span class=sd>        .. note::</span>

<span class=sd>           Uses the magic of :py:func:`inspect.getmembers` to introspect</span>
<span class=sd>           methods beginning with \&#39;test\_\&#39; and calling them.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>members</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>getmembers</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>predicate</span><span class=o>=</span><span class=n>inspect</span><span class=o>.</span><span class=n>ismethod</span><span class=p>)</span>
        <span class=k>for</span> <span class=n>name</span><span class=p>,</span> <span class=n>_</span> <span class=ow>in</span> <span class=n>members</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>name</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>&quot;test_&quot;</span><span class=p>):</span>
                <span class=nb>getattr</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>name</span><span class=p>)()</span>
        <span class=k>return</span> <span class=bp>self</span></div>

<div class=viewcode-block id=Config.test_workers><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_workers>[docs]</a>    <span class=k>def</span> <span class=nf>test_workers</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate the number of workers.</span>

<span class=sd>        :raises ConfigException: If an invalid number of workers is provided.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Cannot have more workers than number of processors or cores.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>cpus</span> <span class=o>=</span> <span class=n>multiprocessing</span><span class=o>.</span><span class=n>cpu_count</span><span class=p>()</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>workers</span> <span class=o>&gt;</span> <span class=n>cpus</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Cannot have more workers than number of processors or &quot;</span>
                <span class=sa>f</span><span class=s2>&quot;cores. </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>workers</span><span class=si>}</span><span class=s2> workers &gt; </span><span class=si>{</span><span class=n>cpus</span><span class=si>}</span><span class=s2> processors/cores.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_ipv6_support><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_ipv6_support>[docs]</a>    <span class=k>def</span> <span class=nf>test_ipv6_support</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        If an IPv6 listener is configured, confirm IPv6 is supported.</span>

<span class=sd>        :raises ConfigException: If IPv6 is configured but is not supported by</span>
<span class=sd>                                 the operating system.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>for</span> <span class=n>address</span><span class=p>,</span> <span class=n>__</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=n>___</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>listen</span><span class=p>:</span>
            <span class=k>if</span> <span class=s2>&quot;:&quot;</span> <span class=ow>in</span> <span class=n>address</span><span class=p>:</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>socket</span><span class=o>.</span><span class=n>has_ipv6</span> <span class=ow>and</span> <span class=n>family</span> <span class=o>==</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_UNSPEC</span><span class=p>:</span>
                    <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;An IPv6 listener is configured but IPv6 is not &quot;</span>
                        <span class=s2>&quot;available on this platform.&quot;</span>
                    <span class=p>)</span>
                    <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_tls_ipv6_support><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_tls_ipv6_support>[docs]</a>    <span class=k>def</span> <span class=nf>test_tls_ipv6_support</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        If an IPv6 listener is configured, confirm IPv6 is supported.</span>

<span class=sd>        :raises ConfigException: If IPv6 is configured but is not supported by</span>
<span class=sd>                                 the operating system.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>for</span> <span class=n>address</span><span class=p>,</span> <span class=n>__</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=n>___</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>:</span>
            <span class=k>if</span> <span class=s2>&quot;:&quot;</span> <span class=ow>in</span> <span class=n>address</span><span class=p>:</span>
                <span class=k>if</span> <span class=ow>not</span> <span class=n>socket</span><span class=o>.</span><span class=n>has_ipv6</span> <span class=ow>and</span> <span class=n>family</span> <span class=o>==</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_UNSPEC</span><span class=p>:</span>
                    <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                        <span class=s2>&quot;An IPv6 listener is configured but IPv6 is not &quot;</span>
                        <span class=s2>&quot;available on this platform.&quot;</span>
                    <span class=p>)</span>
                    <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_same_listeners><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_same_listeners>[docs]</a>    <span class=k>def</span> <span class=nf>test_same_listeners</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Test that multiple listeners are not configured on the same port.</span>

<span class=sd>        :raises ConfigException: When multiple listeners are configured on the</span>
<span class=sd>                                 same port.</span>

<span class=sd>        .. note::</span>

<span class=sd>           IPv4 and IPv6 addresses are different sockets so they can listen on</span>
<span class=sd>           the same port because they have different addresses.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>listen</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=ow>and</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>listen</span><span class=p>,</span> <span class=n>tls_listen</span> <span class=o>=</span> <span class=p>[],</span> <span class=p>[]</span>
        <span class=k>for</span> <span class=n>llisten</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>listen</span><span class=p>:</span>
            <span class=n>addr</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>llisten</span>
            <span class=n>listen</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>addr</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>))</span>
        <span class=k>for</span> <span class=n>llisten</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>:</span>
            <span class=n>addr</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=n>flags</span> <span class=o>=</span> <span class=n>llisten</span>
            <span class=n>tls_listen</span><span class=o>.</span><span class=n>append</span><span class=p>((</span><span class=n>addr</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>))</span>
        <span class=k>if</span> <span class=nb>set</span><span class=p>(</span><span class=n>listen</span><span class=p>)</span><span class=o>.</span><span class=n>intersection</span><span class=p>(</span><span class=n>tls_listen</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Cannot have multiple listeners on the same address and &quot;</span>
                <span class=s2>&quot;port.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_no_listeners><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_no_listeners>[docs]</a>    <span class=k>def</span> <span class=nf>test_no_listeners</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Test that at least one listener is configured.</span>

<span class=sd>        :raises ConfigException: When no listeners are configured.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>listen</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=ow>and</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;You need to define at least one listener.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

    <span class=k>def</span> <span class=nf>_min_max_port</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>port</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Minimum and maximum allowed port.</span>

<span class=sd>        :param int port: The port to test for validity.</span>
<span class=sd>        :raises ConfigException: When port is outside of the allowed range.</span>

<span class=sd>        .. note::</span>

<span class=sd>           On Linux the minimum is 1 and maximum is 65535.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>min_port</span><span class=p>,</span> <span class=n>max_port</span> <span class=o>=</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>65535</span>
        <span class=k>if</span> <span class=n>port</span> <span class=o>&lt;</span> <span class=n>min_port</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;Port number </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2> is not usable because it is less than &quot;</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>min_port</span><span class=si>}</span><span class=s2> which is the lowest available port.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>port</span> <span class=o>&gt;</span> <span class=n>max_port</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=sa>f</span><span class=s2>&quot;Port number </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2> is not usable because it is less than &quot;</span>
                <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>max_port</span><span class=si>}</span><span class=s2> which is the highest available port.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>

<div class=viewcode-block id=Config.test_port><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_port>[docs]</a>    <span class=k>def</span> <span class=nf>test_port</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate port number.</span>

<span class=sd>        :raises ConfigException: When a port is configured that we have no</span>
<span class=sd>                                 permissions for.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>for</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>,</span> <span class=n>__</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>listen</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_port_permissions</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>)</span></div>

    <span class=k>def</span> <span class=nf>_port_permissions</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>address</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>family</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate that we have permission to use the port and it&#39;s not in use.</span>

<span class=sd>        :param str address: The address to use.</span>
<span class=sd>        :param int port: The port to use.</span>
<span class=sd>        :param family: The type of socket to use.</span>
<span class=sd>        :type family: :py:obj:`socket.AF_INET` or :py:obj:`socket.AF_INET6`</span>
<span class=sd>        :raises ConfigException: When a port is supplied that we have no</span>
<span class=sd>                                 permissions for.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_min_max_port</span><span class=p>(</span><span class=n>port</span><span class=p>)</span>
        <span class=k>if</span> <span class=n>os</span><span class=o>.</span><span class=n>getuid</span><span class=p>()</span> <span class=o>!=</span> <span class=mi>0</span> <span class=ow>and</span> <span class=n>port</span> <span class=o>&lt;</span> <span class=mi>1024</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;You do not have permission to use port </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=n>sock</span> <span class=o>=</span> <span class=n>socket</span><span class=o>.</span><span class=n>socket</span><span class=p>(</span><span class=n>family</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SOCK_STREAM</span><span class=p>)</span>
        <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEADDR</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_REUSEPORT</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>except</span> <span class=p>(</span><span class=ne>AttributeError</span><span class=p>,</span> <span class=ne>OSError</span><span class=p>):</span>
            <span class=k>pass</span>
        <span class=k>if</span> <span class=n>family</span> <span class=o>==</span> <span class=n>socket</span><span class=o>.</span><span class=n>AF_INET6</span><span class=p>:</span>
            <span class=n>sock</span><span class=o>.</span><span class=n>setsockopt</span><span class=p>(</span><span class=n>socket</span><span class=o>.</span><span class=n>IPPROTO_IPV6</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>IPV6_V6ONLY</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>sock</span><span class=o>.</span><span class=n>bind</span><span class=p>((</span><span class=n>address</span><span class=p>,</span> <span class=n>port</span><span class=p>))</span>
        <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>err</span><span class=p>:</span>
            <span class=n>errmsg</span> <span class=o>=</span> <span class=n>err</span><span class=o>.</span><span class=n>strerror</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Could not use port </span><span class=si>{</span><span class=n>port</span><span class=si>}</span><span class=s2>, </span><span class=si>{</span><span class=n>errmsg</span><span class=si>}</span><span class=s2>&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=k>finally</span><span class=p>:</span>
            <span class=n>sock</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
            <span class=k>del</span> <span class=n>sock</span>

<div class=viewcode-block id=Config.test_user><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_user>[docs]</a>    <span class=k>def</span> <span class=nf>test_user</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate user exists in UNIX password database.</span>

<span class=sd>        :raises ConfigException: When the user cannot be accessed on the</span>
<span class=sd>                                 operating system.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to :py:func:`getpass.getuser` if no user is specified.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>pwd</span><span class=o>.</span><span class=n>getpwnam</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>user</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_user</span><span class=si>}</span><span class=s2> is not a valid user.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_group><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_group>[docs]</a>    <span class=k>def</span> <span class=nf>test_group</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate group exists in UNIX group database.</span>

<span class=sd>        :raises ConfigException: When the group cannot be accessed on the</span>
<span class=sd>                                 operating system.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Defaults to :py:attr:`grp.getgrgid.gr_name` if no group is</span>
<span class=sd>           specified.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>grp</span><span class=o>.</span><span class=n>getgrnam</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>group</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>KeyError</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_group</span><span class=si>}</span><span class=s2> is a not a valid group.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_timeout><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_timeout>[docs]</a>    <span class=k>def</span> <span class=nf>test_timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate timeout - only allow a valid integer value in seconds.</span>

<span class=sd>        :raises ConfigException: When the timeout is not a number or is above</span>
<span class=sd>                                 the maximum allowed value of 180.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>__</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span>  <span class=c1># NOQA</span>
        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>_timeout</span><span class=si>}</span><span class=s2> is not a valid number of seconds.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span> <span class=o>&gt;</span> <span class=mi>180</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Timeout must be at least 180 seconds or less for security &quot;</span>
                <span class=s2>&quot;(denial of service).&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_tls_port><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_tls_port>[docs]</a>    <span class=k>def</span> <span class=nf>test_tls_port</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate TLS port number.</span>

<span class=sd>        :raises ConfigException: When a port is configured that we have no</span>
<span class=sd>                                 permissions for.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=k>for</span> <span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>af</span><span class=p>,</span> <span class=n>__</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>_port_permissions</span><span class=p>(</span><span class=n>host</span><span class=p>,</span> <span class=n>port</span><span class=p>,</span> <span class=n>af</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_tls_settings><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_tls_settings>[docs]</a>    <span class=k>def</span> <span class=nf>test_tls_settings</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate TLS configuration.</span>

<span class=sd>        :raises ConfigException: When the TLS configuration is invalid.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Verifies if you provide all TLS settings, not just some.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=n>port</span> <span class=o>=</span> <span class=kc>True</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>len</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_listen</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
            <span class=n>port</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=n>cert</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>access</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_cert</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>R_OK</span><span class=p>)</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_cert</span> <span class=k>else</span> <span class=kc>False</span>
        <span class=n>key</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>access</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_key</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>R_OK</span><span class=p>)</span> <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_key</span> <span class=k>else</span> <span class=kc>False</span>
        <span class=k>if</span> <span class=p>(</span><span class=n>port</span><span class=p>,</span> <span class=n>cert</span><span class=p>,</span> <span class=n>key</span><span class=p>)</span> <span class=o>==</span> <span class=p>(</span><span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
            <span class=k>return</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=nb>all</span><span class=p>((</span><span class=n>port</span><span class=p>,</span> <span class=n>cert</span><span class=p>,</span> <span class=n>key</span><span class=p>)):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;To use TLS you must supply a port, certificate file &quot;</span>
                <span class=s2>&quot;and key file.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_tls_dhparams><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_tls_dhparams>[docs]</a>    <span class=k>def</span> <span class=nf>test_tls_dhparams</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate Diffie Hellman ephemeral parameters.</span>

<span class=sd>        :raises ConfigException: When the dhparams file is invalid.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Verifies Diffie Hellman ephemeral parameters are readable.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>tls_dhparams</span> <span class=ow>and</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>access</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>tls_dhparams</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>R_OK</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;To use Diffie Hellman ephemeral params you must supply a &quot;</span>
                <span class=s2>&quot;valid dhparams file.&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_delay><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_delay>[docs]</a>    <span class=k>def</span> <span class=nf>test_delay</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate the delay period.</span>

<span class=sd>        :raises ConfigException: When the delay is not a number or is above</span>
<span class=sd>                                 the maximum allowed value of 60.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Delay must be lower than the timeout.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>delay</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>delay</span> <span class=o>&gt;=</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Delay must be lower than timeout.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>delay</span> <span class=ow>and</span> <span class=bp>self</span><span class=o>.</span><span class=n>delay</span> <span class=o>&gt;</span> <span class=mi>60</span><span class=p>:</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=p>(</span>
                <span class=s2>&quot;Delay must be 60 seconds or less for security (denial of &quot;</span>
                <span class=s2>&quot;service).&quot;</span>
            <span class=p>)</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_mode><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_mode>[docs]</a>    <span class=k>def</span> <span class=nf>test_mode</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate the response mode.</span>

<span class=sd>        :raise ConfigException: When an invalid mode is configured.</span>

<span class=sd>        .. note::</span>

<span class=sd>           Valid options are: &#39;accept&#39;, &#39;bounce&#39; and &#39;random&#39;.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>mode</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=s2>&quot;accept&quot;</span><span class=p>,</span> <span class=s2>&quot;bounce&quot;</span><span class=p>,</span> <span class=s2>&quot;random&quot;</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Mode must be accept, bounce or random.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_max_message_size><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_max_message_size>[docs]</a>    <span class=k>def</span> <span class=nf>test_max_message_size</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate max_message size is an integer.</span>

<span class=sd>        :raise ConfigException: When the maximum message size is not a number.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>__</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>max_message_size</span>  <span class=c1># NOQA</span>
        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
            <span class=n>size</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_max_message_size</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>size</span><span class=si>}</span><span class=s2> is not a valid number of bytes.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_pidfile><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_pidfile>[docs]</a>    <span class=k>def</span> <span class=nf>test_pidfile</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate that the pidfile can be written to.</span>

<span class=sd>        :raises ConfigException: When the pidfile is invalid.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>pidfile</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>pidfile</span> <span class=o>=</span> <span class=n>pathlib</span><span class=o>.</span><span class=n>Path</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>pidfile</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>os</span><span class=o>.</span><span class=n>access</span><span class=p>(</span><span class=n>pidfile</span><span class=o>.</span><span class=n>parent</span><span class=p>,</span> <span class=n>os</span><span class=o>.</span><span class=n>W_OK</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;You do not have permission to write to the pidfile.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div>

<div class=viewcode-block id=Config.test_dynamic_switch><a class=viewcode-back href=../../api-config.html#blackhole.config.Config.test_dynamic_switch>[docs]</a>    <span class=k>def</span> <span class=nf>test_dynamic_switch</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=sd>&quot;&quot;&quot;</span>
<span class=sd>        Validate that the dynamic_switch value is correct.</span>

<span class=sd>        :raises ConfigException: When the dynamic switch value is invalid.</span>
<span class=sd>        &quot;&quot;&quot;</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_dynamic_switch</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=kc>True</span><span class=p>,</span> <span class=kc>False</span><span class=p>):</span>
            <span class=n>msg</span> <span class=o>=</span> <span class=s2>&quot;Allowed dynamic_switch values are true and false.&quot;</span>
            <span class=k>raise</span> <span class=n>ConfigException</span><span class=p>(</span><span class=n>msg</span><span class=p>)</span></div></div>
</pre></div> </div> </div> <div class=clearfix></div> </div> <div class=related role=navigation aria-label="related navigation"> <h3>Navigation</h3> <ul> <li class=right style="margin-right: 10px"> <a href=../../genindex.html title="General Index">index</a></li> <li class=right> <a href=../../py-modindex.html title="Python Module Index">modules</a> |</li> <li class="nav-item nav-item-0"><a href=../../index.html>Blackhole 2.1.19 documentation</a> &#187;</li> <li class="nav-item nav-item-1"><a href=../index.html>Module code</a> &#187;</li> <li class="nav-item nav-item-this"><a href>blackhole.config</a></li> </ul> </div><script type=text/javascript>
  $("#mobile-toggle a").click(function () {
    $("#left-column").toggle();
  });
</script><script type=text/javascript src=../../_static/js/bootstrap.js></script> <div class=footer> &copy; Copyright 2013-2021, Kura. Created using <a href=http://sphinx.pocoo.org/ >Sphinx</a>. </div> </body></html>